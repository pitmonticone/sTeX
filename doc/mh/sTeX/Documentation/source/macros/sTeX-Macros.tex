\documentclass{stex}
\libinput{docpreamble}
\begin{document}
  \begin{smodule}{sTeX-Macros}
    \STEXexport{
      \stex_sms_allow_escape:N \stexmacro
      \protected\def\stexmacro#1{
          \stex_execute_in_module:x{\tl_set:cn{l_stex_stexmacro_\tl_to_str:n{#1}_path}{\l_stex_current_module_str?\tl_to_str:n{#1}}}
          \exp_args:NNx\symdecl*{\tl_to_str:n{#1}}
          \exp_args:Nx\notation{\tl_to_str:n{#1}}{\noexpand\comp{\noexpand\texttt{\noexpand\textbackslash\noexpand\detokenize{#1}}}}
      }
      \protected\def\stexvarmacro#1{
        \tl_set:cx{l_stex_stexvarmacro_\tl_to_str:n{#1}_var}{\tl_to_str:n{#1}}
        \exp_args:Nnx\use:nn{\vardef}{
          {\tl_to_str:n{varmacro_#1}}[name={\tl_to_str:n{#1}}]{
            \noexpand\comp{\hbox{\noexpand\texttt{\noexpand\textbackslash\noexpand\detokenize{#1}}}}
          }
        }
      }
      \stex_sms_allow_escape:N \stexenv
      \protected\def\stexenv#1{
          \stex_execute_in_module:x{\tl_set:cn{l_stex_stexenv_\tl_to_str:n{#1}_path}{\l_stex_current_module_str?\tl_to_str:n{#1}}}
          \exp_args:NNx\symdecl*{\tl_to_str:n{#1}}
          \exp_args:Nx\notation{\tl_to_str:n{#1}}{\noexpand\texttt{\noexpand\detokenize{#1}}}
      }

      \cs_set_nopar:Nn \_stexdoc_do_cs:nn {
        \tl_if_exist:cTF{l_stex_stexvarmacro_\tl_to_str:n{#1}_var}{
          \exp_args:Nx \varref{\use:c{l_stex_stexvarmacro_\tl_to_str:n{#1}_var}}{#2}
        }{
          \tl_if_exist:cTF{l_stex_stexmacro_\tl_to_str:n{#1}_path}{
            \exp_args:Nx \symref{\use:c{l_stex_stexmacro_\tl_to_str:n{#1}_path}}{#2}
          }{#2}
        }
      }

      \RenewDocumentCommand\cmd { O{} m }
        { \_stexdoc_do_cs:nn{#2}{\__codedoc_cmd:no {#1} { \token_to_str:N #2 }} }
      \RenewDocumentCommand \cs  { O{} m }
        { \_stexdoc_do_cs:nn{#2}{\__codedoc_cmd:no {#1} { \c_backslash_str #2 }} }
      \RenewDocumentCommand \tn  { O{} m }
      { \_stexdoc_do_cs:nn{#2}{
        \@@_cmd:no
          { module = TeX , replace = false , #1 }
          { \c_backslash_str #2 }
      }}
      \protected\def\env#1{
        \tl_if_exist:cTF{l_stex_stexenv_\tl_to_str:n{#1}_path}{
          \exp_args:Nx \symref{\use:c{l_stex_stexenv_\tl_to_str:n{#1}_path}}{\texttt{\tl_to_str:n{#1}}}
        }{\texttt{\tl_to_str:n{#1}}}
      }

      \cs_set_protected:Nn \_stexdoc_dcs: {
        \peek_charcode:NTF [ {
          \_stexdoc_dcs:w
        }{
          \exp_args:NNe \use:nn \_stexdoc_dcs:w {[\seq_item:Nn \_stexdoc_sfunction_seq 1]}
        }
      }

      \cs_set_protected:Npn \_stexdoc_dcs:w [#1] {
        \exp_args:Ne \definiendum{\tl_to_str:n{#1}}{\exp_args:Nne \__codedoc_cmd:nn {} { \c_backslash_str \tl_to_str:n{ #1 } }}
        \xspace
      }

      \ProvideDocumentEnvironment {sfunction}{m O{} +v}{
        \seq_set_split:Nnn \_stexdoc_sfunction_seq , {#1}
        \seq_map_inline:Nn \_stexdoc_sfunction_seq {
          \stex_pseudogroup_with:nn{\stex_smsmode_do:}{\def\stex_smsmode_do:{}\stexmacro{##1}}
        }
        \cs_set_eq:NN \dcs \_stexdoc_dcs:
        \begin{sparagraph}[style=symdoc,for={#1}]
          \__codedoc_function:nnw{#2}{#3}
      }{
        \__codedoc_function_end:
        \end{sparagraph}
      }
      \stex_sms_allow_env:n{sfunction}

      \ProvideDocumentEnvironment { svariable } { m +v }
      {
        \seq_set_split:Nnn \_stexdoc_sfunction_seq , {#1}
        \seq_map_inline:Nn \_stexdoc_sfunction_seq {
          \stex_pseudogroup_with:nn{\stex_smsmode_do:}{\def\stex_smsmode_do:{}\stexmacro{##1}}
        }
        \cs_set_eq:NN \dcs \_stexdoc_dcs:
        \begin{sparagraph}[style=symdoc,for={#1}]
        \bool_if:NTF \l__codedoc_in_implementation_bool
          { \__codedoc_macro:nnw { var , } {#2} }
          { \__codedoc_function:nnw {} {#2} }
      }
      {
        \bool_if:NTF \l__codedoc_in_implementation_bool
          { \__codedoc_macro_end: }
          { \__codedoc_function_end: }
        \end{sparagraph}
      }
      \stex_sms_allow_env:n{svariable}

      \ProvideDocumentEnvironment {senv} {m} {
        \def\denv{\exp_args:Ne\definiendum{\tl_to_str:n{#1}}{\texttt{\tl_to_str:n{#1}}}}
        \stex_pseudogroup_with:nn{\stex_smsmode_do:}{\def\stex_smsmode_do:{}\stexenv{#1}}
        \begin{sparagraph}[style=symdoc,for={#1}]
        \exp_args:Ne\DescribeEnv{\tl_to_str:n{#1}}
      }{
        \end{sparagraph}
      }
      \stex_sms_allow_env:n{senv}

    }
  \end{smodule}
\end{document}
