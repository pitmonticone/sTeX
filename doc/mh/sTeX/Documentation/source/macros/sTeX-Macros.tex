\documentclass{stex}
\libinput{docpreamble}
\begin{document}
  \begin{smodule}{sTeX-Macros}
    \STEXexport{
      \stex_sms_allow_escape:N \stexmacro
      \protected\def\stexmacro#1{
          \exp_args:Nx\STEXexport{\tl_set:cn{l_stex_stexmacro_\tl_to_str:n{#1}_path}{\l_stex_current_module_str?#1}}
          \exp_args:NNx\symdecl*{\tl_to_str:n{#1}}
          \exp_args:Nx\notation{\tl_to_str:n{#1}}{\texttt{\c_backslash_str\tl_to_str:n{#1}}}
      }

      \stex_sms_allow_escape:N \stexenv
      \protected\def\stexenv#1{
          \exp_args:Nx\STEXexport{\tl_set:cn{l_stex_stexenv_\tl_to_str:n{#1}_path}{\l_stex_current_module_str?#1}}
          \exp_args:NNx\symdecl*{\tl_to_str:n{#1}}
          \exp_args:Nx\notation{\tl_to_str:n{#1}}{\texttt{\tl_to_str:n{#1}}}
      }

      \cs_set_nopar:Nn \_stexdoc_do_cs:nn {
        \tl_if_exist:cTF{l_stex_stexmacro_\tl_to_str:n{#1}_path}{
          \exp_args:Nx \symref{\use:c{l_stex_stexmacro_\tl_to_str:n{#1}_path}}{#2}
        }{#2}
      }

      \RenewDocumentCommand\cmd { O{} m }
        { \_stexdoc_do_cs:nn{#2}{\__codedoc_cmd:no {#1} { \token_to_str:N #2 }} }
      \RenewDocumentCommand \cs  { O{} m }
        { \_stexdoc_do_cs:nn{#2}{\__codedoc_cmd:no {#1} { \c_backslash_str #2 }} }
      \RenewDocumentCommand \tn  { O{} m }
      { \_stexdoc_do_cs:nn{#2}{
        \@@_cmd:no
          { module = TeX , replace = false , #1 }
          { \c_backslash_str #2 }
      }}
      \protected\def\env#1{
        \tl_if_exist:cTF{l_stex_stexenv_\tl_to_str:n{#1}_path}{
          \exp_args:Nx \symref{\use:c{l_stex_stexenv_\tl_to_str:n{#1}_path}}{\texttt{\tl_to_str:n{#1}}}
        }{\texttt{\tl_to_str:n{#1}}}
      }
    }
  \end{smodule}
\end{document}
