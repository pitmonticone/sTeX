
\usepackage{lststex,mdframed}
\usepackage[most]{tcolorbox}

\lstnewenvironment{stexcode}[1][]{\lstset{language=sTeX,#1}}{}

\newenvironment{framed}{\begin{mdframed}\begin{center}}{\end{center}\end{mdframed}}
\newcommand{\scaled}[2][0.9\hsize]{\begin{center}\resizebox{#1}{!}{\begin{minipage}{\textwidth} #2 \end{minipage}}\end{center}}

\makeatletter
\ExplSyntaxOn

\def\doc_exbox:nnn#1#2#3{
  \begin{sexample}[#3]
    Input:
    \begin{mdframed}[linewidth=1pt,backgroundcolor=white]\small
      #1
    \end{mdframed}
    Output:
    \begin{mdframed}[linewidth=1pt,backgroundcolor=white]\small
      #2
    \end{mdframed}
  \end{sexample}
}


\NewDocumentCommand\stexexamplefile{O{} m O{} O{}}{
  \exp_args:NNNx \exp_args:NNnx \stex_resolve_path_pair:Nnn \l_@@_filepath_str {\tl_to_str:n{#1}} {\tl_to_str:n{#2}}
  \doc_exbox:nnn{
    \hfill File~\str_if_empty:nTF{#1}{
      \prop_if_exist:NT \l_stex_current_repository_prop {
        [\prop_item:Nn \l_stex_current_repository_prop {id}]
      }
    }{[#1]}\texttt{\tl_to_str:n{#2}}
    \lstinputlisting[language=sTeX, #3]{\l_@@_filepath_str}
  }{
    \inputref[#1]{#2}
  }{#4}
}

\newwrite\testoutfile
\NewDocumentCommand\stexexample{O{} O{}}{
  \begingroup 
  \catcode`\\=12\relax
  \catcode`\#=12\relax
  \catcode`\&=12\relax
  \catcode`\$=12\relax
  \catcode`\^=12\relax
  \catcode`\_=12\relax
  \catcode`\ =12\relax
  \catcode`^^J=12\relax
  \endlinechar=`^^J
  \newlinechar=-1
%^^A    \everyeof{\noexpand}
  \example_a:nnn{#1}{#2}
}
\long\def\example_a:nnn #1 #2 #3 {
  \endgroup
  \immediate\openout\testoutfile=stextest.tex
  \immediate\write\testoutfile{
    \c_backslash_str begin{stexcode}[#1]
    \detokenize{^^J}#3
    \c_backslash_str end{stexcode}
  }
  \immediate\closeout\testoutfile
  \doc_exbox:nnn{
    \catcode`\#=12\relax
    \csname @ @ input\endcsname{stextest.tex}
  }{
    \immediate\openout\testoutfile=stextest.tex
    \immediate\write\testoutfile{#3}
    \immediate\closeout\testoutfile
    \csname @ @ input\endcsname stextest.tex\relax
  }{#2}
  \peek_charcode_remove:NT ^^J
}

\ExplSyntaxOff
\makeatother
