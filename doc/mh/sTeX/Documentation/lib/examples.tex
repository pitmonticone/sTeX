
\usepackage{lststex,mdframed}
\usepackage[most]{tcolorbox}

\lstnewenvironment{stexcode}[1][]{\lstset{language=sTeX,#1}}{}

\newenvironment{framed}{\begin{mdframed}\begin{center}}{\end{center}\end{mdframed}}
\newcommand{\scaled}[2][0.9\hsize]{\begin{center}\resizebox{#1}{!}{\begin{minipage}{\textwidth} #2 \end{minipage}}\end{center}}

\makeatletter
\newcount\example@counter\example@counter=0
\newtcolorbox{exampleborderbox}{
  empty,
  title={Example \the\example@counter},
  attach boxed title to top left,
     minipage boxed title,
  boxed title style={empty,size=minimal,toprule=0pt,top=1pt,left=3mm,overlay={}},
  coltitle=blue,fonttitle=\bfseries,
  parbox=false,boxsep=0pt,left=3mm,right=0mm,top=2pt,breakable,pad at break=0mm,
     before upper=\csname @totalleftmargin\endcsname0pt, 
  overlay unbroken={\draw[blue,line width=2pt] ([xshift=-0pt]title.north west) -- ([xshift=-0pt]frame.south west); },
  overlay first={\draw[blue,line width=2pt] ([xshift=-0pt]title.north west) -- ([xshift=-0pt]frame.south west); },
  overlay middle={\draw[blue,line width=2pt] ([xshift=-0pt]frame.north west) -- ([xshift=-0pt]frame.south west); },
  overlay last={\draw[blue,line width=2pt] ([xshift=-0pt]frame.north west) -- ([xshift=-0pt]frame.south west); },
  outer arc=4pt%
}

\ExplSyntaxOn

\def\doc_exbox:nn#1#2{
  \global\advance\example@counter by 1
  \begin{exampleborderbox}
    Input:
    \begin{mdframed}[linewidth=1pt,backgroundcolor=white]\small
      #1
    \end{mdframed}
    Output:
    \begin{mdframed}[linewidth=1pt,backgroundcolor=white]\small
      #2
    \end{mdframed}
  \end{exampleborderbox}
}


\NewDocumentCommand\stexexamplefile{O{} m O{}}{
  \stex_resolve_path_pair:Nnn \l_@@_filepath_str {#1} {#2}
  \doc_exbox:nn{
    \lstinputlisting[language=sTeX, #3]{\l_@@_filepath_str}
  }{
    \inputref[#1]{#2}
  }
}

\newwrite\testoutfile
\newcommand\stexexample[1][]{
  \begingroup 
  \catcode`\\=12\relax
  \catcode`\#=12\relax
  \catcode`\&=12\relax
  \catcode`\$=12\relax
  \catcode`\^=12\relax
  \catcode`\_=12\relax
  \catcode`\ =12\relax
  \catcode`^^J=12\relax
  \endlinechar=`^^J
  \newlinechar=-1
%^^A    \everyeof{\noexpand}
  \example_a:nn{#1}
}
\long\def\example_a:nn #1 #2 {
  \endgroup
  \immediate\openout\testoutfile=stextest.tex
  \immediate\write\testoutfile{
    \c_backslash_str begin{stexcode}[#1]
    \detokenize{^^J}#2
    \c_backslash_str end{stexcode}
  }
  \immediate\closeout\testoutfile
  \doc_exbox:nn{
    \catcode`\#=12\relax
    \csname @ @ input\endcsname{stextest.tex}
  }{
    \immediate\openout\testoutfile=stextest.tex
    \immediate\write\testoutfile{#2}
    \immediate\closeout\testoutfile
    \csname @ @ input\endcsname stextest.tex\relax
  }
  \peek_charcode_remove:NT ^^J
}

\ExplSyntaxOff
\makeatother
