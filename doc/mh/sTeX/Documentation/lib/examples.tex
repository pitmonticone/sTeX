
\usepackage{lststex,mdframed}
\usepackage[most]{tcolorbox}

\lstset{literate=%
    {Ö}{{\"O}}1
    {Ä}{{\"A}}1
    {Ü}{{\"U}}1
    {ß}{{\ss}}1
    {ü}{{\"u}}1
    {ä}{{\"a}}1
    {ö}{{\"o}}1
    {~}{{\textasciitilde}}1
}

\lstnewenvironment{stexcode}[1][]{\lstset{language=sTeX,#1}}{}

\newenvironment{framed}[1][]{
  \ifstexhtml\par\vbox\bgroup
    \csname exp_args:Nne\endcsname\begin{stex_annotate_env}{style={%
      border:solid 1px black;%
      width:98\csname c_percent_str\endcsname;%
      padding:1\csname c_percent_str\endcsname
    }}
  \else\begin{mdframed}[#1]\fi
  %\begin{center}%
}{
  %\end{center}%
  \ifstexhtml
    \end{stex_annotate_env}\egroup\par
  \else\end{mdframed}\fi
}
\newcommand{\scaled}[2][0.9\hsize]{\begin{center}\resizebox{#1}{!}{\begin{minipage}{\textwidth} #2 \end{minipage}}\end{center}}

\makeatletter
\ExplSyntaxOn

\def\doc_exbox:nnn#1#2#3{
  \begin{sexample}[#3]
    Input:
    \begin{framed}[linewidth=1pt,backgroundcolor=white]\small
      #1
    \end{framed}
    Output:
    \begin{framed}[linewidth=1pt,backgroundcolor=white]\small
      #2
    \end{framed}
  \end{sexample}
}


\NewDocumentCommand\stexexamplefile{O{} m O{} O{}}{
  \stex_resolve_path_pair:Nxx \l_@@_filepath_str {\tl_to_str:n{#1}} {\tl_to_str:n{#2}}
  \doc_exbox:nnn{
    \hfill File~\str_if_empty:nTF{#1}{
      \prop_if_exist:NT \l_stex_current_archive_prop {
        [\texttt{\prop_item:Nn \l_stex_current_archive_prop {id}}]
      }
    }{[#1]}\texttt{\tl_to_str:n{#2}}
    \lstinputlisting[language=sTeX, #3]{\l_@@_filepath_str}
  }{
    \inputref[#1]{#2}
  }{#4}
}

\newwrite\testoutfile
\NewDocumentCommand\stexexample{O{} O{}}{
  \begingroup 
  \catcode`\\=12\relax
  \catcode`\#=12\relax
  \catcode`\&=12\relax
  \catcode`\$=12\relax
  \catcode`\^=12\relax
  \catcode`\_=12\relax
  \catcode`\ =12\relax
  \catcode`^^J=12\relax
  \endlinechar=`^^J
  \newlinechar=-1
%^^A    \everyeof{\noexpand}
  \example_a:nnn{#1}{#2}
}
\long\def\example_a:nnn #1 #2 #3 {
  \endgroup
  \immediate\openout\testoutfile=stextest.tex
  \immediate\write\testoutfile{
    \c_backslash_str begin{stexcode}[#1]
    \detokenize{^^J}#3
    \c_backslash_str end{stexcode}
  }
  \immediate\closeout\testoutfile
  \doc_exbox:nnn{
    \catcode`\#=12\relax
    \csname @ @ input\endcsname{stextest.tex}
  }{
    \immediate\openout\testoutfile=stextest.tex
    \immediate\write\testoutfile{#3}
    \immediate\closeout\testoutfile
    \csname @ @ input\endcsname stextest.tex\relax
  }{#2}
  \peek_charcode_remove:NT ^^J
}

\ExplSyntaxOff
\makeatother
