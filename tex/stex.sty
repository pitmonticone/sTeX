%%
%% This is file `stex.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% stex.dtx  (with options: `package')
%% 
\RequirePackage{expl3,l3keys2e,ltxcmds}
\ProvidesExplPackage{stex}{2022/09/14}{3.3.0}{sTeX package}
\RequirePackage{stex-logo} % externalized for backwards-compatibility reasons
\RequirePackage{standalone}

\message{^^J*~This~is~sTeX~version~3.3.0~*^^J}
\keys_define:nn { stex } {
  debug     .str_set_x:N  = \c_stex_debug_clist ,
  lang      .clist_set:N  = \c_stex_languages_clist ,
  mathhub   .tl_set_x:N   = \mathhub ,
  usesms    .bool_set:N   = \c_stex_persist_mode_bool ,
  writesms  .bool_set:N   = \c_stex_persist_write_mode_bool ,
  image     .bool_set:N   = \c_tikzinput_image_bool,
  unknown   .code:n       = {}
}
\exp_args:NNo \clist_set:Nn \c_stex_debug_clist \c_stex_debug_clist
\ProcessKeysOptions { stex }
\input{stex-en.ldf}
\cs_new_protected:Nn \stex_kpsewhich:Nn {\group_begin:
  \catcode`\ =12
  \sys_get_shell:nnN { kpsewhich ~ #2 } { } \l_tmpa_tl
  \tl_gset_eq:NN \l_tmpa_tl \l_tmpa_tl
  \group_end:
  \exp_args:NNo\str_set:Nn #1 {\l_tmpa_tl}
  \tl_trim_spaces:N #1
}
\sys_if_platform_windows:TF{
  \cs_new_protected:Nn \stex_get_env:Nnn {\group_begin:
    \escapechar=-1\catcode`\\=12
    \stex_kpsewhich:Nn-1{-expand-var~\c_percent_str#3\c_percent_str}
    \exp_args:NNx\use:nn\group_end:{
      \str_set:Nn\exp_not:N#1{#1}
    }
  }
}{
  \cs_new_protected:Nn \stex_get_env:Nnn {
    \stex_kpsewhich:Nn #1 {-var-value~#2}
  }
}
\cs_new_protected:Nn \stex_get_env:Nn {
  \stex_get_env:Nnn #1{#2}{#2}
}
\cs_new_protected:Nn \stex_debug:nn {
  \clist_if_in:NnTF \c_stex_debug_clist { all }{
    \__stex_debug_:nn{#1}{#2}
  }{
    \clist_if_in:NnT \c_stex_debug_clist { #1 }{}{
      \__stex_debug_:nn{#1}{#2}
    }
  }
}

\cs_new_protected:Nn \__stex_debug_:nn {
  \msg_set:nnn{stex}{debug / #1}{
    \\Debug~#1:~#2\\
  }
  \msg_none:nn{stex}{debug / #1}
}

\cs_new_protected:Nn \_stex_fatal_error:n {
  \msg_error:nn{stex}{#1}\input{Fatal~Error!!}
}
\cs_new_protected:Nn \_stex_fatal_error:nnn {
  \msg_error:nnn{stex}{#1}{#2}{#3}\input{Fatal~Error!!}
}
\cs_generate_variant:Nn \_stex_fatal_error:nnn {nxx}
\stex_get_env:Nn\__stex_debug_env_str{STEX_DEBUG}
\str_if_empty:NF\__stex_debug_env_str {
  \clist_set:No \c_stex_debug_clist {\__stex_debug_env_str}
}
\cs_undefine:N\__stex_debug_env_str

\exp_args:NNo \clist_if_in:NnTF \c_stex_debug_clist {\tl_to_str:n{all}} {
    \msg_redirect_module:nnn{ stex }{ none }{ term }
    \stex_debug:nn{all}{Logging~everything!}
}{
  \clist_map_inline:Nn \c_stex_debug_clist {
    \msg_redirect_name:nnn{ stex }{ debug / #1 }{ term }
    \stex_debug:nn{#1}{Logging~#1}
  }
}
\exp_args:NNx \prop_const_from_keyval:Nn \c_stex_languages_prop { \tl_to_str:n {
  en = english ,
  de = ngerman ,
  ar = arabic ,
  bg = bulgarian ,
  ru = russian ,
  fi = finnish ,
  ro = romanian ,
  tr = turkish ,
  fr = french
}}

\exp_args:NNx \prop_const_from_keyval:Nn \c_stex_language_abbrevs_prop { \tl_to_str:n {
  english   = en ,
  ngerman   = de ,
  arabic    = ar ,
  bulgarian = bg ,
  russian   = ru ,
  finnish   = fi ,
  romanian  = ro ,
  turkish   = tr ,
  french    = fr
}}
\str_new:N \l_stex_current_language_str
\cs_new_protected:Nn \stex_set_language:n {
  \str_set:Nn \l_stex_current_language_str { #1 }
  \prop_if_in:NnTF \c_stex_languages_prop {#1} {
    \cs_if_eq:NNTF\@onlypreamble\@notprerr{
      \ltx@ifpackageloaded{babel}{
        \exp_args:Nx\selectlanguage{
          \prop_item:Nn \c_stex_languages_prop {#1}
        }
      }{}
    }{
      \str_if_eq:nnTF {#1} {tr} {
        \RequirePackage[turkish,shorthands=:!]{babel}
      }{
        \RequirePackage[\prop_item:Nn \c_stex_languages_prop {#1}]{babel}
      }
    }
  }{
    \msg_error:nnx{stex}{error/unknownlanguage}{#1}
  }
}
\cs_generate_variant:Nn \stex_set_language:n {x,o}
\cs_new_protected:Nn \_stex_current_language: {
  \seq_get_right:NN \g_stex_current_file \l_tmpa_str
  \seq_set_split:NnV \l_tmpa_seq . \l_tmpa_str
  \seq_pop_right:NN \l_tmpa_seq \l_tmpa_str % = ".tex"
  \exp_args:No \str_if_eq:nnF \l_tmpa_str {tex} {
    \exp_args:No \str_if_eq:nnF \l_tmpa_str {dtx} {
      \exp_args:No \str_if_eq:nnF \l_tmpa_str {ltx} {
        \exp_args:NNo \seq_put_right:Nn \l_tmpa_seq \l_tmpa_str
      }
    }
  }
  \seq_pop_left:NN \l_tmpa_seq \l_tmpa_str % <filename>
  \seq_if_empty:NF \l_tmpa_seq { %remaining element should be [<something>.]language
    \seq_pop_right:NN \l_tmpa_seq \l__stex_lang_str
    \str_if_eq:NNF \l__stex_lang_str \l_stex_current_language_str {
      \stex_set_language:o \l__stex_lang_str
    }
    \stex_debug:nn{lang} {Language~\l_stex_current_language_str~
      inferred~from~file~name}
  }
}
\cs_new_protected:Nn \stex_pseudogroup:nn {
  \exp_args:Nnx \use:nn {#1}{#2}
}
\cs_new:Nn \stex_pseudogroup_restore:N {
  \tl_if_exist:NTF #1 {
    \tl_set:Nn \exp_not:N #1 { \exp_args:No \exp_not:n #1 }
  }{
    \cs_undefine:N \exp_not:N #1
  }
}
\cs_new_protected:Nn \stex_pseudogroup_with:nn {
  \tl_map_inline:nn{#1}{
    \cs_set_eq:cN{__stex_groups_\tl_to_str:n{##1}}##1
  }
  #2
  \tl_map_inline:nn{#1}{
    \cs_set_eq:Nc##1{__stex_groups_\tl_to_str:n{##1}}
    \cs_undefine:c{__stex_groups_\tl_to_str:n{##1}}
  }
}
\seq_new:N \l__stex_groups_ids_seq
\cs_new_protected:Nn \stex_metagroup_new:n {
    \str_set:cx{l__stex_groups_#1_int} {\int_use:N\currentgrouplevel}
    \seq_put_right:Nn \l__stex_groups_ids_seq {#1}
}
\cs_generate_variant:Nn \stex_metagroup_new:n {o}
\prg_new_conditional:Nnn \__stex_groups_exists:n {TF} {
    \str_if_exist:cTF{l__stex_groups_#1_int}
        \prg_return_true: \prg_return_false:
}

\cs_new_protected:Nn \stex_metagroup_do_in:nn {
    \__stex_groups_exists:nTF{#1}{
        \__stex_groups_do_in:nn{#1}{#2}
    }{
      \msg_error:nnn{stex}{error/metagroup/missing}{#1}
    }
}
\cs_generate_variant:Nn \stex_metagroup_do_in:nn {nx}

\cs_new_protected:Nn \__stex_groups_do_in:nn {
  \exp_args:Nnx\stex_debug:nn{metagroup}{adding~\detokenize{#2}~to~\detokenize{#1}}
  \tl_set:Nn\__stex_groups_tmp{#2}
  \exp_args:Nx \int_compare:nNnF {\use:c{l__stex_groups_#1_int}}
      = \currentgrouplevel {
      \tl_if_exist:cTF{g__stex_groups_#1_\the\currentgrouplevel _content}{
        \exp_args:Nno \tl_gput_right:cn{{g__stex_groups_#1_\the\currentgrouplevel _content}}
      }{
        \exp_args:Nno \tl_gset:cn{{g__stex_groups_#1_\the\currentgrouplevel _content}}
      }\__stex_groups_tmp
      \bool_if_exist:cF {l__stex_groups_\the\currentgrouplevel _bool} {
          \group_insert_after:N \__stex_groups_do:
          \bool_set_true:c {l__stex_groups_\the\currentgrouplevel _bool}
      }
  }
  \__stex_groups_tmp
}

\cs_new_protected:Nn \__stex_groups_do: {
    \seq_map_inline:Nn \l__stex_groups_ids_seq {
        \tl_if_exist:cT{g__stex_groups_##1_\int_eval:n{\currentgrouplevel+1}_content}{
            \exp_args:NNno \exp_args:Nno \__stex_groups_do_in:nn{##1}{
                \csname g__stex_groups_##1_\int_eval:n{\currentgrouplevel+1}_content\endcsname
            }
            \cs_undefine:c{g__stex_groups_##1_\int_eval:n{\currentgrouplevel+1}_content}
        }
        \bool_if_exist:cF {l__stex_groups_\int_eval:n\currentgrouplevel _bool} {
            \group_insert_after:N \__stex_groups_do:
            \bool_set_true:c {l__stex_groups_\int_eval:n\currentgrouplevel _bool}
        }
    }
}
\bool_new:N \_stex_html_do_output_bool
\bool_set_true:N \_stex_html_do_output_bool

\prg_new_conditional:Nnn \stex_if_do_html: {p,T,F,TF} {
  \bool_if:nTF \_stex_html_do_output_bool
    \prg_return_true: \prg_return_false:
}
\cs_new_protected:Nn \stex_suppress_html:n {
  \stex_pseudogroup:nn{
    \bool_set_false:N \_stex_html_do_output_bool
    #1
  }{
    \stex_if_do_html:T {
      \bool_set_true:N \_stex_html_do_output_bool
    }
  }
}
\ifcsname if@rustex\endcsname\else
  \expandafter\newif\csname if@rustex\endcsname
  \@rustexfalse
\fi
\ifcsname if@latexml\endcsname\else
  \expandafter\newif\csname if@latexml\endcsname
  \@latexmlfalse
\fi
\tl_if_exist:NF\stex@backend{
  \if@rustex
    \def\stex@backend{rustex}
  \else
    \if@latexml
      \def\stex@backend{latexml}
    \else
      \cs_if_exist:NTF\HCode{
        \def\stex@backend{tex4ht}
      }{
        \def\stex@backend{pdflatex}
      }
    \fi
  \fi
}
\input{stex-backend-\stex@backend.cfg}

\newif\ifstexhtml
\stex_html_backend:TF\stexhtmltrue\stexhtmlfalse

\cs_new_protected:Nn \stex_deactivate_macro:Nn {
  \tl_set_eq:cN{\tl_to_str:n{#1}~-~orig}#1
  \tl_set:Nn#1{
    \msg_error:nnnn{stex}{error/deactivated-macro}{\detokenize{#1}}{#2}
  }
}
\cs_new_protected:Nn \stex_reactivate_macro:N {
  \exp_after:wN\let\exp_after:wN#1\csname \detokenize{#1} - orig\endcsname
}
\protected\def\ignorespacesandpars{
  \begingroup\catcode13=10\relax
  \@ifnextchar\par{
    \endgroup\expandafter\ignorespacesandpars\@gobble
  }{
    \endgroup
  }
}
\cs_new_nopar:Nn \stex_keys_define:nnnn {
  \tl_gset:cn {__stex_aux_keys_#1_pre_tl}{#2}
  \tl_gset:cn {__stex_aux_keys_#1_def_tl}{#3}
  \tl_if_empty:nF{#4}{
    \clist_map_inline:nn{#4}{
      \tl_set_eq:Nc \l__stex_aux_tl {__stex_aux_keys_##1_pre_tl}
      \tl_gput_left:co{__stex_aux_keys_#1_pre_tl} \l__stex_aux_tl
      \tl_set_eq:Nc \l__stex_aux_tl {__stex_aux_keys_##1_def_tl}
      \tl_gput_left:cn{__stex_aux_keys_#1_def_tl} ,
      \tl_gput_left:co{__stex_aux_keys_#1_def_tl} \l__stex_aux_tl
    }
  }
  \tl_set_eq:Nc \l__stex_aux_tl {__stex_aux_keys_#1_def_tl}
  \exp_args:Nnx \stex_debug:nn{keys}{
    Setting~keys~for~#1:^^J
    \meaning \l__stex_aux_tl
  }
  \exp_args:Nno \keys_define:nn {stex / #1} {\l__stex_aux_tl}
}
\cs_new_nopar:Nn \stex_keys_set:nn {
  \use:c{__stex_aux_keys_#1_pre_tl}
  \keys_set:nn {stex / #1} { #2 }
}
\stex_keys_define:nnnn{archive file}{
  \str_clear:N \l_stex_key_archive_str
  \str_clear:N \l_stex_key_file_str
}{
  archive .str_set_x:N = \l_stex_key_archive_str ,
  file    .str_set_x:N = \l_stex_key_file_str
}{}

\stex_keys_define:nnnn{id}{
  \str_clear:N \l_stex_key_id_str
}{
  id .str_set_x:N = \l_stex_key_id_str
}{}

\stex_keys_define:nnnn{title}{
  \tl_clear:N \l_stex_key_title_tl
}{
  title .tl_set:N = \l_stex_key_title_tl
}{}

\stex_keys_define:nnnn{style}{
  \str_clear:N \l_stex_key_style_str
}{
  style .str_set_x:N = \l_stex_key_style_str
}{}
\cs_new_protected:Nn \stex_new_stylable_cmd:nnnnn {
  \exp_after:wN \newcommand \cs:w stexstyle#1 \cs_end:[2][]{
    \__stex_aux_patch:nnn{#1}{##1}{##2}
  }
  \NewDocumentCommand{#1}{#2}{
    \cs_set:Npn \stex_style_apply: {
      \__stex_aux_apply_patch:n{#1}
    }
    #3
  }
  \tl_set:cn {__stex_aux_style_#1:} { #4 }
  \tl_set:cn {__stex_aux_style_#1:} { #5 }
}

\cs_new_protected:Nn \__stex_aux_patch:nnn {
  \str_if_empty:nTF {#2}{
    \tl_set:cn{__stex_aux_style_#1:}{#3}
  }{
    \tl_set:cn{__stex_aux_style_#1_#2:}{#3}
  }
}

\cs_new_protected:Nn \stex_new_stylable_env:nnnnnn {
  \exp_after:wN \newcommand \cs:w stexstyle#1 \cs_end:[3][]{
    \__stex_aux_patch:nnnn{#1}{##1}{##2}{##3}
  }
  \NewDocumentEnvironment{s#1}{#2}{
    \cs_set:Npn \stex_style_apply: {
      \__stex_aux_apply_patch_begin:n{#1}
    }
    #3
  }{
    \cs_set:Npn \stex_style_apply: {
      \__stex_aux_apply_patch_end:n{#1}
    }
    #4
  }
  \tl_set:cn {__stex_aux_style_#1_start:} { #5 }
  \tl_set:cn {__stex_aux_style_#1_end:} { #6 }
}

\cs_new_protected:Nn \__stex_aux_patch:nnnn {
  \str_if_empty:nTF {#2}{
    \tl_set:cn{__stex_aux_style_#1_start:}{#3}
    \tl_set:cn{__stex_aux_style_#1_end:}{#4}
  }{
    \tl_set:cn{__stex_aux_style_#1_#2_start:}{#3}
    \tl_set:cn{__stex_aux_style_#1_#2_end:}{#4}
  }
}

\cs_new_protected:Nn \__stex_aux_apply_patch_begin:n {
  \tl_set_eq:NN \thistitle \l_stex_key_title_tl
  \tl_set_eq:NN \thisstyle \l_stex_key_style_str
  \tl_set_eq:NN \thisid \l_stex_key_id_str
  \tl_if_empty:NTF \thisstyle {
    \use:c{__stex_aux_style_#1_start:}
  }{
    \tl_if_exist:cTF{__stex_aux_style_#1_\thisstyle _start:}{
      \use:c{__stex_aux_style_#1_\thisstyle _start:}
    }{
      \use:c{__stex_aux_style_#1_start:}
    }
  }
}

\cs_new_protected:Nn \__stex_aux_apply_patch_end:n {
  \tl_if_empty:NTF \thisstyle {
    \use:c{__stex_aux_style_#1_end:}
  }{
    \tl_if_exist:cTF{__stex_aux_style_#1_\thisstyle _end:}{
      \use:c{__stex_aux_style_#1_\thisstyle _end:}
    }{
      \use:c{__stex_aux_style_#1_end:}
    }
  }
}
\stex_get_env:Nn\__stex_persist_env_str{STEX_USESMS}
\str_if_empty:NF\__stex_persist_env_str{
  \exp_args:No \str_if_eq:nnF \__stex_persist_env_str{false}{
    \bool_set_true:N \c_stex_persist_mode_bool
  }
}
\stex_get_env:Nn\__stex_persist_env_str{STEX_WRITESMS}
\str_if_empty:NF\__stex_persist_env_str{
  \exp_args:No \str_if_eq:nnF \__stex_persist_env_str{false}{
    \bool_set_true:N \c_stex_persist_write_mode_bool
    \bool_set_false:N \c_stex_persist_mode_bool
  }
}
\cs_undefine:N \__stex_persist_env_str

\cs_set:Npn \stex_persist:n #1 {}
\cs_set:Npn \stex_persist:x #1 {}
\cs_set:Npn \stex_persist:o #1 {}

\bool_if:NT \c_stex_persist_write_mode_bool {
  \iow_new:N \c__stex_persist_iow
  \iow_open:Nn \c__stex_persist_iow{\jobname.sms}
  \AtEndDocument{
    \iow_close:N \c__stex_persist_iow
  }
  \cs_new_protected:Nn \stex_persist:n {
    \tl_set:Nn \l_tmpa_tl { #1 }
    \regex_replace_all:nnN { \cP\# } { \cO\# } \l_tmpa_tl
    \regex_replace_all:nnN { \  } { \~ } \l_tmpa_tl
    \exp_args:NNo \iow_now:Nn \c__stex_persist_iow \l_tmpa_tl
  }
  \cs_generate_variant:Nn \stex_persist:n {x,o}
}

\cs_set_protected:Nn \stex_read_persist: {
  \bool_if:NT \c_stex_persist_mode_bool {
    % TODO
      \input{\jobname.sms}
    % TODO
  }
}
\cs_new_protected:Nn \stex_file_set:Nn {
  \str_if_empty:nTF {#2} { \seq_clear:N #1 }{
    \exp_args:NNno \seq_set_split:Nnn #1 / { \tl_to_str:n{#2} }
  }
}
\cs_generate_variant:Nn \stex_file_set:Nn {No, Nx}
\sys_if_platform_windows:TF{
  \cs_new_protected:Npn \__stex_path_win_take:nnw #1#2#3 \__stex_path_: {
    \str_set:Nn \l__stex_path_win_drive {#1#2}
    \str_set:Nn \l__stex_path_str{#3}
  }
  \cs_new_protected:Nn \stex_file_resolve:Nn {
    \str_set:Nn \l__stex_path_str {#2}
    \str_clear:N \l__stex_path_win_drive
    \exp_args:NNo \str_replace_all:Nnn \l__stex_path_str \c_backslash_str /
    \exp_args:Nx \tl_if_eq:nnT {\str_item:Nn \l__stex_path_str 2} : {
      \exp_after:wN \__stex_path_win_take:w \l__stex_path_str \__stex_path_:
    }
    \stex_file_set:No #1 \l__stex_path_str
    \__stex_path_canonicalize:N #1
    \str_if_empty:NF \l__stex_path_win_drive {
      \seq_put_left:No #1 \l__stex_path_win_drive
    }
    \stex_debug:nn{files}{Set~\tl_to_str:n{#1}~to~\stex_file_use:N #1}
  }
}{
  \cs_new_protected:Nn \stex_file_resolve:Nn {
    \str_set:Nn \l__stex_path_str {#2}
    \stex_file_set:No #1 \l__stex_path_str
    \__stex_path_canonicalize:N #1
    \stex_debug:nn{files}{Set~\tl_to_str:n{#1}~to~\stex_file_use:N #1}
  }
}
\cs_generate_variant:Nn \stex_file_resolve:Nn {No, Nx}

\cs_new_protected:Nn \__stex_path_canonicalize:N {
  \seq_if_empty:NF #1 {
    \seq_pop:NN #1 \l__stex_path_str
    \seq_clear:N \l__stex_path_seq
    \str_if_empty:NTF \l__stex_path_str {
      \seq_map_function:NN #1 \__stex_path_dodots:n
      \seq_put_left:Nn \l__stex_path_seq {}
    }{
      \seq_push:No #1 \l__stex_path_str
      \seq_map_function:NN #1 \__stex_path_dodots:n
    }
    \seq_set_eq:NN #1 \l__stex_path_seq
  }
}

\cs_new_protected:Nn \__stex_path_dodots:n {
  \str_if_empty:nF{#1}{
    \str_if_eq:nnF {#1} {.} {
      \str_if_eq:nnTF {#1} {..} {
        \seq_if_empty:NF \l__stex_path_seq {
          \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str
        }
      }{
        \seq_put_right:Nn \l__stex_path_seq {#1}
      }
    }
  }
}

\sys_if_platform_windows:TF {
  \prg_new_conditional:Nnn \stex_file_absolute:N {p, T, F, TF} {
    \seq_if_empty:NTF \prg_return_false: {
      \tl_set:Nx \l__stex_path_maybewin_str {\seq_item:Nn #1 1}
      \exp_args:No \tl_if_empty:nTF \l__stex_path_maybewin \prg_return_true: {
        \exp_args:Nx \tl_if_eq:nnTF {\str_item:Nn \l__stex_path_maybewin 2} :
          \prg_return_true: \prg_return_false:
      }
    }
  }
}{
  \prg_new_conditional:Nnn \stex_file_absolute:N {p, T, F, TF} {
    \seq_if_empty:NTF \prg_return_false: {
      \exp_args:Nx \tl_if_empty:nTF {\seq_item:Nn #1 1}
        \prg_return_true: \prg_return_false:
    }
  }
}
\cs_new:Nn \stex_file_use:N {
  \seq_use:Nn #1 /
}
\prg_new_protected_conditional:Nnn \stex_file_starts_with:NN {T,F,TF} {
  \seq_set_eq:NN \l__stex_path_a_seq #1
  \seq_set_eq:NN \l__stex_path_b_seq #2
  \tl_clear:N \l__stex_path_return_tl
  \bool_while_do:nn{
    \bool_not_p:n{
      \bool_lazy_any_p:n{
        {\seq_if_empty_p:N \l__stex_path_a_seq}
        {\seq_if_empty_p:N \l__stex_path_b_seq}
        {\bool_not_p:n{\tl_if_empty_p:N \l__stex_path_return_tl}}
      }
    }
  }{
    \seq_pop_left:NN \l__stex_path_a_seq \l__stex_path_a_tl
    \seq_pop_left:NN \l__stex_path_b_seq \l__stex_path_b_tl
    \tl_if_eq:NNF \l__stex_path_a_seq \l__stex_path_b_seq {
      \tl_set:Nn \l__stex_path_return_tl {\prg_return_false:}
    }
  }
  \tl_if_empty:NTF \l__stex_path_return_tl {
    \seq_if_empty:NTF \l__stex_path_b_seq \prg_return_true: \prg_return_false:
  } \l__stex_path_return_tl
}
\cs_new_protected:Nn \stex_file_split_off_ext:NN {
  \seq_set_eq:NN #1 #2
  \seq_pop_right:NN #1 \l__stex_path_str
  \seq_set_split:NnV \l__stex_path_seq . \l__stex_path_str
  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str
  \seq_put_right:Nx #1 {\seq_use:Nn \l__stex_path_seq .}
}
\cs_new_protected:Nn \stex_file_split_off_lang:NN {
  \seq_set_eq:NN #1 #2
  \seq_pop_right:NN #1 \l__stex_path_str
  \seq_set_split:NnV \l__stex_path_seq . \l__stex_path_str
  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str

  \seq_pop_right:NN \l__stex_path_seq \l__stex_path_str
  \exp_args:NNo \prop_if_in:NnF \c_stex_languages_prop \l__stex_path_str {
    \seq_put_right:No \l__stex_path_seq \l__stex_path_str
  }

  \seq_put_right:Nx #1 {\seq_use:Nn \l__stex_path_seq .}
}
\cs_set_protected:Nn \__stex_path_auth:n {
  \msg_error:nnx{stex}{error/misused-uri}{\tl_to_str:n{#1}}
}
\cs_set_eq:NN \__stex_path_path:n \__stex_path_auth:n
\cs_set_eq:NN \__stex_path_module:n \__stex_path_auth:n
\cs_set_eq:NN \__stex_path_name:n \__stex_path_auth:n

\cs_set_protected:Nn \stex_map_uri:Nnnnn{
  \stex_pseudogroup_with:nn{\__stex_path_auth:n\__stex_path_path:n\__stex_path_module:n\__stex_path_name:n}{
    \cs_set:Npn \__stex_path_auth:n ##1 {#2}
    \cs_set:Npn \__stex_path_path:n ##1 {#3}
    \cs_set:Npn \__stex_path_module:n ##1 {#4}
    \cs_set:Npn \__stex_path_name:n ##1 {#5}
    #1
  }
}
\cs_new_protected:Nn \__stex_path_uri_set:NnN {
  \str_if_empty:nTF {#2} {
    \msg_error:nnxx{stex}{error/invalid-uri}{\tl_to_str:n{#2}}{empty}
  }{
    \exp_args:NNno \seq_set_split:Nnn #1 {:/} { \tl_to_str:n{#2} }
    \seq_pop_left:NN #1 \l__stex_path_auth_str
    \seq_if_empty:NTF #1 {
      \msg_error:nnxx{stex}{error/invalid-uri}{\tl_to_str:n{#2}}{missing~authority}
    }{
      \exp_args:NNnx \seq_set_split:Nnn #1 ? {\seq_use:Nn {:/} }
      \seq_pop_left:NN #1 \l__stex_path_path
      #3 \l__stex_path_path \l__stex_path_path
      \seq_if_empty:NTF #1 {
        \exp_args:NNo \__stex_path_uri_set:Nnxnn #1 \l__stex_path_auth_str
          {\stex_file_use:N \l__stex_path_path} {} {}
      }{
        \seq_pop_left:NN #1 \l__stex_path_mod
        \seq_if_empty:NTF #1 {
          \exp_args:NNo \__stex_path_uri_set:Nnxon #1 \l__stex_path_auth_str
            {\stex_file_use:N \l__stex_path_path} \l__stex_path_mod {}
        }{
          \seq_pop_left:NN #1 \l__stex_path_name
          \seq_if_empty:NTF #1 {
            \exp_args:NNo \__stex_path_uri_set:Nnxon #2 \l__stex_path_auth_str
              {\stex_file_use:N \l__stex_path_path} \l__stex_path_mod \l__stex_path_name
          }{
            \msg_error:nnxx{stex}{error/invalid-uri}{\tl_to_str:n{#2}}{too~many~?s}
          }
        }
      }
    }
  }
  \stex_debug:nn{uris}{Set~\tl_to_str:n{#1}~to~\stex_uri_use:N #1}
}

\cs_new_protected:Nn \__stex_path_uri_set:Nnnnn{
  \tl_set:Nn #1 {
    \__stex_path_auth:n{ #2 }
    \__stex_path_path:n{ #3 }
    \__stex_path_module:n{ #4 }
    \__stex_path_name:n{ #5 }
  }
}
\cs_generate_variant:Nn\__stex_path_uri_set:Nnnnn {Nnxnn,Nnxon,Nnxoo}

\cs_new_protected:Nn \stex_uri_set:Nn {
  \__stex_path_uri_set:NnN #1 {#2} \stex_file_set:No
}
\cs_generate_variant:Nn \stex_uri_set:Nn {No, Nx}
\cs_new_protected:Nn \stex_uri_resolve:Nn {
  \__stex_path_uri_set:NnN #1 {#2} \stex_file_resolve:No
}
\cs_generate_variant:Nn \stex_uri_resolve:Nn {No, Nx}
\cs_new:Npn \__stex_path_uri_use:w \__stex_path_auth:n #1 \__stex_path_path:n #2 \__stex_path_module:n #3 \__stex_path_name:n #4 {
  #1\c_colon_str/ #2 \tl_if_empty:nF { #3 }{ ? #3
    \tl_if_empty:nF { #4 }{ ? #4 } }
}
\cs_new:Nn \stex_uri_use:N {
  \exp_args:Ne \cs_if_eq:NNTF { \tl_head:N #1 } \__stex_path_auth:n {
    \exp_after:wN \__stex_path_uri_use:w #1
  }{
    \msg_error:nnnn{stex}{error/invalid-uri}{#1}{Not~a~URI}
  }
}
\cs_new_protected:Npn \stex_uri_from_repo_file_nolang:NNNn {
  \__stex_path_from_repo_file:NNNNn \stex_file_split_off_lang:NN
}
\cs_new_protected:Npn \stex_uri_from_repo_file:NNNn {
  \__stex_path_from_repo_file:NNNNn \stex_file_split_off_ext:NN
}

\cs_new_protected:Nn \__stex_path_from_repo_file:NNNNn {
  #1 \l__stex_path_file #4
  \prop_if_exist:NTF #3 {
    \str_clear:N \l__stex_path_uri
    \prop_get:NnNF #3 {#5} \l__stex_path_uri {
      \prop_get:NnNF #3 {ns} \l__stex_path_uri {
        \__stex_path_uri_set:Nnxnn #2 {file}
          {\stex_file_use:N \l__stex_path_file} {} {}
      }
    }
    \str_if_empty:NF \l__stex_path_uri {\__stex_path_relativize:N #2}
  }{
    \exp_args:NNx \__stex_path_uri_set:Nnxnn #2 {\tl_to_str:n{file}}
      {\stex_file_use:N \l__stex_path_file} {} {}
  }
}

\cs_new_protected:Nn \__stex_path_relativize:N {
  \seq_set_eq:NN \l__stex_path_seq \l__stex_path_file
  \seq_map_inline:Nn \c_stex_mathhub_file { % mathhub path
    \seq_pop_left:NN \l__stex_path_seq \l__stex_path_tl
  }
  \stex_file_set:Nx \l__stex_path_path {\prop_item:Nn \l_stex_current_repository_prop {id} }
  \seq_map_inline:Nn \l__stex_path_path { % id
    \seq_pop_left:NN \l__stex_path_seq \l__stex_path_tl
  }
  \seq_pop_left:NN \l__stex_path_seq \l__stex_path_tl % source

  \stex_uri_set:Nx #1 { \l__stex_path_uri / \stex_file_use:N \l__stex_path_seq }
}
\cs_new_protected:Nn \stex_uri_from_current_file:Nn {
  \stex_uri_from_repo_file:NNNn #1 \l_stex_current_repository_prop
    \g_stex_current_file {#2}
}
\cs_new_protected:Nn \stex_uri_from_current_file_nolang:Nn {
  \stex_uri_from_repo_file_nolang:NNNn #1 \l_stex_current_repository_prop
    \g_stex_current_file {#2}
}
\cs_new_protected:Nn \stex_uri_add_module:NNn {
  \exp_args:Ne \cs_if_eq:NNTF { \tl_head:N #2 } \__stex_path_auth:n {
    \stex_pseudogroup_with:nn
      {\__stex_path_auth:n\__stex_path_path:n\__stex_path_module:n\__stex_path_name:n}
      {
        \cs_set:Npn \__stex_path_module:n ##1 {
          \tl_if_empty:nTF{##1}{
            \exp_not:N \__stex_path_module:n {#3}
          }{
            \msg_error:nnn{stex}{error/invalid-dpath}{#2}
          }
        }
        \cs_set:Npn \__stex_path_name:n ##1 {
          \tl_if_empty:nTF{##1}{
            \exp_not:N \__stex_path_name:n {}
          }{
            \msg_error:nnn{stex}{error/invalid-dpath}{#2}
          }
        }
        \tl_set:Nx #1 {#2}
      }
  }{
    \msg_error:nnnn{stex}{error/invalid-uri}{#2}{Not~a~URI}
  }
}
\cs_generate_variant:Nn \stex_uri_add_module:NNn {NNo}
\stex_get_env:Nnn\l__stex_path_str{PWD}{CD}
\stex_file_resolve:No \c_stex_pwd_file \l__stex_path_str
\seq_set_eq:NN \c_stex_main_file \c_stex_pwd_file
\seq_put_right:Nx \c_stex_main_file {\jobname\tl_to_str:n{.tex}}

\stex_debug:nn {files} {PWD:~\stex_file_use:N \c_stex_pwd_file}
\seq_gclear_new:N\g__stex_path_stack
\seq_gclear_new:N\g_stex_current_file
\cs_new_protected:Nn \stex_filestack_push:n {
  \exp_args:Nx \tl_if_eq:nnTF {\str_head:n{#1}} / {
    \str_set:Nn \l__stex_path_str {#1}
  }{
    \str_set:Nx \l__stex_path_str {\stex_file_use:N \c_stex_pwd_file / #1}
  }
  \stex_file_resolve:No \g_stex_current_file \l__stex_path_str
  \seq_gset_eq:NN \g_stex_current_file \g_stex_current_file
  \exp_args:NNx \seq_gpush:Nn \g__stex_path_stack {\stex_file_use:N \g_stex_current_file}
  \stex_get_document_uri:
  \stex_get_current_namespace:
}
\cs_new_protected:Nn \stex_filestack_pop: {
  \seq_if_empty:NF \g__stex_path_stack {
    \seq_gpop:NN \g__stex_path_stack \l__stex_path_str
  }
  \seq_if_empty:NTF \g__stex_path_stack {
    \seq_gset_eq:NN \g_stex_current_file \c_stex_main_file
  }{
    \seq_get:NN \g__stex_path_stack \l__stex_path_str
    \exp_args:NNo \stex_file_set:Nn \g_stex_current_file \l__stex_path_str
    \seq_gset_eq:NN \g_stex_current_file \g_stex_current_file
  }
  \stex_get_document_uri:
  \stex_get_current_namespace:
}

\AddToHook{file/before}{
  \tl_if_empty:NTF\CurrentFilePath{
    \exp_args:No \stex_filestack_push:n \CurrentFile
  }{
    \exp_args:Nx \stex_filestack_push:n { \CurrentFilePath / \CurrentFile }
  }
}
\AddToHook{file/after}{ \stex_filestack_pop: }
\str_if_empty:NTF\mathhub{
  \stex_get_env:Nn \l__stex_mathhub_str {MATHHUB}
  \str_if_empty:NTF \l__stex_mathhub_str {
    \sys_if_platform_windows:TF{
      \stex_get_env:Nn \l__stex_mathhub_str {homedrive\c_percent_str\c_percent_str homepath}
    }{
      \stex_get_env:Nn \l__stex_mathhub_str {HOME}
    }
    \ior_open:NnTF \g_tmpa_ior{\l__stex_mathhub_str/.stex/mathhub.path}{
      \group_begin:
        \escapechar=-1\catcode`\\=12
        \ior_str_get:NN \g_tmpa_ior \l__stex_mathhub_str
        \str_gset_eq:NN \l__stex_mathhub_str \l__stex_mathhub_str
      \group_end:
      \ior_close:N \g_tmpa_ior
      \stex_debug:nn{mathhub}{MathHub~directory~determined~from~home~directory}
    }{
      \str_clear:N \l__stex_mathhub_str
    }
  }{
    \stex_debug:nn{mathhub}{MathHub~directory~determined~from~environment~variable}
  }
}{
  \str_set_eq:NN \l__stex_mathhub_str \mathhub
}

\str_if_empty:NTF \l__stex_mathhub_str {
  \msg_warning:nn{stex}{warning/nomathhub}
  \seq_clear:N \c_stex_mathhub_file
  \str_clearn:N \mathhub
}{
  \stex_file_resolve:No \c_stex_mathhub_file \l__stex_mathhub_str
  \str_set:Nx \mathhub {\stex_file_use:N \c_stex_mathhub_file}
  \stex_debug:nn{mathhub}{MATHHUB:~\mathhub}
}
\cs_new_protected:Nn \stex_set_current_repository:n {
  \stex_require_repository:n { #1 }
  \prop_set_eq:Nc \l_stex_current_repository_prop {
    c_stex_mathhub_#1_manifest_prop
  }
}
\cs_new_protected:Nn \stex_require_repository:n {
  \prop_if_exist:cF { c_stex_mathhub_#1_manifest_prop } {
    \seq_if_empty:NTF \c_stex_mathhub_file {
      \_stex_fatal_error:n{warning/nomathhub}
    }{
      \stex_debug:nn{mathhub}{Opening~archive:~#1}
      \__stex_mathhub_do_manifest:n { #1 }
    }
  }
}
\cs_generate_variant:Nn \stex_require_repository:n {o}

\cs_new_protected:Nn \__stex_mathhub_do_manifest:n {
  \__stex_mathhub_find_manifest:n {#1}
  \str_if_empty:NT \l__stex_mathhub_manifest_str {
    \_stex_fatal_error:nxx{error/norepository}
      {#1}{\stex_file_use:N \c_stex_mathhub_file}
  }
  \__stex_mathhub_parse_manifest:n {#1}
}

\cs_new_protected:Nn \__stex_mathhub_find_manifest:n {
  \str_clear:N \l__stex_mathhub_manifest_str
  \exp_args:NNnx \seq_set_split:Nnn \l__stex_mathhub_seq /
    {\stex_file_use:N \c_stex_mathhub_file / #1}
  \bool_set_true:N \l__stex_mathhub_bool
  \bool_while_do:Nn \l__stex_mathhub_bool {
    \tl_if_eq:NNTF \l__stex_mathhub_seq \c_stex_mathhub_file {
      \bool_set_false:N \l__stex_mathhub_bool
    }{
      \__stex_mathhub_check_manifest:
      \bool_if:NT \l__stex_mathhub_bool {
        \seq_pop_right:NN \l__stex_mathhub_seq \l__stex_mathhub_tl
      }
    }
  }
}
\cs_generate_variant:Nn \__stex_mathhub_find_manifest:n {x}

\cs_new_protected:Nn \__stex_mathhub_check_manifest: {
  \__stex_mathhub_check_manifest:n {MANIFEST.MF}
  \bool_if:NT \l__stex_mathhub_bool {
    \__stex_mathhub_check_manifest:n {META-INF/MANIFEST.MF}
    \bool_if:NT \l__stex_mathhub_bool {
      \__stex_mathhub_check_manifest:n {meta-inf/MANIFEST.MF}
    }
  }
}

\cs_new_protected:Nn \__stex_mathhub_check_manifest:n {
  \stex_debug:nn{mathhub}{Checking~\stex_file_use:N \l__stex_mathhub_seq / #1}
  \file_if_exist:nT {\stex_file_use:N \l__stex_mathhub_seq / #1} {
    \bool_set_false:N \l__stex_mathhub_bool
    \str_set:Nx \l__stex_mathhub_manifest_str {\stex_file_use:N \l__stex_mathhub_seq / #1}
  }
}

\ior_new:N \c__stex_mathhub_manifest_ior
\cs_new_protected:Nn \__stex_mathhub_parse_manifest:n {
  \ior_open:Nn \c__stex_mathhub_manifest_ior \l__stex_mathhub_manifest_str
  \prop_clear:N \l__stex_mathhub_prop
  \ior_map_inline:Nn \c__stex_mathhub_manifest_ior {
    \seq_set_split:Nnn \l__stex_mathhub_seq : {##1}
    \seq_pop_left:NNT \l__stex_mathhub_seq \l__stex_mathhub_key {
      \exp_args:NNo \str_set:Nn \l__stex_mathhub_key \l__stex_mathhub_key
      \str_set:Nx \l__stex_mathhub_val {\seq_use:Nn \l__stex_mathhub_seq :}
      \str_set:Nx \l__stex_mathhub_val {\exp_args:No \tl_to_str:n \l__stex_mathhub_val}
      \str_case:Nn \l__stex_mathhub_key {
        {id}              {\prop_put:Nno \l__stex_mathhub_prop { id }      \l__stex_mathhub_val }
        {narration-base}  {\prop_put:Nno \l__stex_mathhub_prop { narr }    \l__stex_mathhub_val }
        {url-base}        {\prop_put:Nno \l__stex_mathhub_prop { docurl }  \l__stex_mathhub_val }
        {source-base}     {\prop_put:Nno \l__stex_mathhub_prop { ns }      \l__stex_mathhub_val }
        {ns}              {\prop_put:Nno \l__stex_mathhub_prop { ns }      \l__stex_mathhub_val }
      }
    }
  }
  \ior_close:N \c__stex_mathhub_manifest_ior
  \prop_gset_eq:cN { c_stex_mathhub_#1_manifest_prop } \l__stex_mathhub_prop
  \stex_persist:x {
    \prop_set_from_keyval:cn { c_stex_mathhub_#1_manifest_prop }{
      \exp_after:wN \prop_to_keyval:N
      \cs:w c_stex_mathhub_#1_manifest_prop \cs_end:
    }
  }
}
\bool_if:NF \c_stex_persist_mode_bool {
  \seq_if_empty:NF \c_stex_mathhub_file {
    \stex_file_starts_with:NNTF \c_stex_pwd_file \c_stex_mathhub_file {
      \__stex_mathhub_find_manifest:x { \stex_file_use:N \c_stex_pwd_file }
      \str_if_empty:NTF \l__stex_mathhub_manifest_str {
        \stex_debug:nn{mathhub}{Not~currently~in~a~MathHub~repository}
      }{
        \__stex_mathhub_parse_manifest:n { main }
        \prop_get:NnN \c_stex_mathhub_main_manifest_prop {id}
          \l__stex_mathhub_str
        \prop_set_eq:cN { c_stex_mathhub_\l__stex_mathhub_str _manifest_prop }
          \c_stex_mathhub_main_manifest_prop
        \exp_args:No \stex_set_current_repository:n { \l__stex_mathhub_str }
        \stex_debug:nn{mathhub}{Current~repository:~
          \prop_item:Nn \l_stex_current_repository_prop {id}
        }
      }
    }{
      \stex_debug:nn{mathhub}{Not~currently~in~the~MathHub~directory}
    }
  }
}
\iow_new:N \c__stex_refs_iow
\AtBeginDocument{\iow_open:Nn \c__stex_refs_iow {\jobname.sref}}
\AtEndDocument{\iow_close:N \c__stex_refs_iow}
\tl_new:N \l_stex_current_doc_uri
\cs_new_protected:Nn \stex_get_document_uri: {
  \stex_uri_from_current_file:Nn \l_stex_current_doc_uri {narr}
  \stex_debug:nn{sref}{Document~URI:~\stex_uri_use:N \l_stex_current_doc_uri}
}
\seq_new:N \g__stex_refs_files_seq
\int_new:N \l__stex_refs_unnamed_counter_int

\cs_new_protected:Nn \__stex_refs_add_doc_ref:nn {
  \seq_if_in:NnTF \g__stex_refs_files_seq {#1} {
    \seq_if_in:cnF {g__stex_refs_#1_seq}{#2}{
      \seq_gput_left:cn{g__stex_refs_#1_seq}{#2}
    }
  }{
    \seq_gput_right:Nn \g__stex_refs_files_seq {#1}
    \seq_new:c{g__stex_refs_#1_seq}
    \seq_gput_left:cn{g__stex_refs_#1_seq}{#2}
  }
}
\cs_generate_variant:Nn \__stex_refs_add_doc_ref:nn {xo,xx}

\cs_new_protected:Npn \STEXInternalAuxAddDocRef #1 #2 {
  \__stex_refs_add_doc_ref:xx{\tl_to_str:n{#1}}{\tl_to_str:n{#2}}
}
\AtEndDocument{
  \cs_set:Npn \STEXInternalAuxAddDocRef #1 #2 {}
}
\cs_new_protected:Npn \STEXInternalSrefRestoreTarget #1#2#3#4#5 {}

\cs_new_protected:Nn \stex_ref_new_doc_target:n {
  \str_if_empty:nTF {#1}{
    \int_gincr:N \l__stex_refs_unnamed_counter_int
    \str_set:Nx \l__stex_refs_str {REF\int_use:N \l__stex_refs_unnamed_counter_int}
  }{
    \str_set:Nn \l__stex_refs_str {#1}
  }
  \stex_uri_add_module:NNo \l__stex_refs_uri \l_stex_current_doc_uri \l__stex_refs_str
  \stex_debug:nn{sref}{New~document~target:~\stex_uri_use:N \l__stex_refs_uri}
  \__stex_refs_add_doc_ref:xo {\stex_uri_use:N \l_stex_current_doc_uri} \l__stex_refs_str
  \stex_if_smsmode:F {
    \iow_now:Nx \c__stex_refs_iow {
      \STEXInternalSrefRestoreTarget
      {\stex_uri_use:N \l_stex_current_doc_uri}
      {\l__stex_refs_str}
      {\@currentcounter}
      {\@currentlabel}
      {
        \tl_if_exist:NT\@currentlabelname{
          \exp_args:No\exp_not:n\@currentlabelname
        }
      }
    }
    \exp_args:Nx\label{sref_ \stex_uri_use:N \l__stex_refs_uri}
    \iow_now:Nx\@auxout{
      \STEXInternalAuxAddDocRef
      {\stex_uri_use:N \l_stex_current_doc_uri}
      {\l__stex_refs_str}
    }
  }
}
\NewDocumentCommand \slabel {m} {\stex_ref_new_doc_target:n {#1}}
\stex_keys_define:nnnn{sref / 1}{}{
  % TODO get rid of this
  fallback  .code:n = {},
  pre       .code:n = {},
  post      .code:n = {}
}{archive file}
\stex_keys_define:nnnn{sref / 2}{}{}{archive file, title}
\cs_new_protected:Nn \__stex_refs_find_uri:n {
  \str_clear:N \l__stex_refs_uri_str
  \stex_debug:nn{sref}{
    File:~\l_stex_key_file_str^^J
    Repo:\l_stex_key_archive_str
  }
  \str_if_empty:NTF \l_stex_key_file_str {
    \stex_debug:nn{sref}{Empty.~Checking~current~file~for~#1}
    \seq_if_exist:cT{g__stex_refs_\stex_uri_use:N \l_stex_current_doc_uri _seq}{
      \exp_args:Nnx \__stex_refs_find_uri_in_file:nnn{#1}
        {\stex_uri_use:N \l_stex_current_doc_uri}\seq_map_break:
    }
    \str_if_empty:NT \l__stex_refs_uri_str {
      \seq_map_inline:Nn \g__stex_refs_files_seq {
        \__stex_refs_find_uri_in_file:nnn{#1}{##1}{\seq_map_break:n{\seq_map_break:}}
      }
    }
  }{
    \str_if_empty:NTF \l_stex_key_archive_str {
      \prop_if_exist:NTF \l_stex_current_repository_prop {
        \__stex_refs_find_uri_in_prop_file:N \l_stex_current_repository_prop
      }{
        \stex_file_resolve:Nx \l__stex_refs_file
          { \stex_file_use:N \g_stex_current_file / .. / \l_stex_key_file_str }
        \str_set:Nx \l__stex_refs_uri_str { file:/ \stex_file_use:N \l__stex_refs_file }
      }
    }{
      \stex_require_repository:o \l_stex_key_archive_str
      \prop_set_eq:Nc \l__stex_refs_prop { c_stex_mathhub_\l_stex_key_archive_str _manifest_prop }
      \__stex_refs_find_uri_in_prop_file:N \l__stex_refs_prop
    }
  }
}

\cs_new_protected:Nn \__stex_refs_find_uri_in_prop_file:N {
  \str_set:Nx \l__stex_refs_uri_str {
    \stex_file_use:N \c_stex_mathhub_file /
    \prop_item:Nn #1 {id} /
      source / \l_stex_key_file_str
  }
  \stex_file_resolve:No \l__stex_refs_file \l__stex_refs_uri_str
  \stex_uri_from_repo_file:NNNn \l__stex_refs_uri #1
    \l__stex_refs_file {narr}
  \str_set:Nx \l__stex_refs_uri_str {\stex_uri_use:N \l__stex_refs_uri}
}

\cs_new_protected:Nn \__stex_refs_find_uri_in_file:nnn {
  \stex_debug:nn{sref}{Checking~file~#2}
  \seq_map_inline:cn{g__stex_refs_#2_seq}{
    \str_if_eq:nnT{#1}{##1}{
      \str_set:Nx \l__stex_refs_uri_str {\stex_uri_use:N \l_stex_current_doc_uri}
      \stex_debug:nn{sref}{Found.}
      #3
    }
  }
}
\cs_new_protected:Nn \__stex_refs_do_autoref:n {
  \cs_if_exist:cTF{autoref}{
     \exp_args:Nx\autoref{sref_#1}
   }{
     \exp_args:Nx\ref{sref_#1}
   }
}

\cs_new_protected:Nn \__stex_refs_do_sref:nn {
  \str_if_empty:NTF \l__stex_refs_uri_str {
    \str_if_empty:NTF \l_stex_key_file_str {
      \stex_debug:nn{sref}{autoref~on~#1}
      \__stex_refs_do_autoref:n{#1}
    }{
      \stex_debug:nn{sref}{srefin~on~#1}
      \stex_keys_set:nn { sref / 2 }{ #2 }
      \__stex_refs_do_sref_in:n{#1}
    }
  }{
    \exp_args:NNo \seq_if_in:NnTF \g__stex_refs_files_seq \l__stex_refs_uri_str {
      \stex_debug:nn{sref}{Using~ref~file~\l__stex_refs_uri_str}
      \exp_args:Nnx \seq_if_in:cnTF{g_stex_ref_\l__stex_refs_uri_str _seq}{\detokenize{#1}}{
        \stex_debug:nn{sref}{Reference~found~in~ref~files;~autoref~on~\l__stex_refs_uri_str?#1}
        \__stex_refs_do_autoref:n{\l__stex_refs_uri_str?#1}
      }{
        \str_if_empty:NTF \l_stex_key_file_str {
          \stex_debug:nn{sref}{in~empty;~autoref~on~\l__stex_refs_uri_str?#1}
          \__stex_refs_do_autoref:n{\l__stex_refs_uri_str?#1}
        }{
          \stex_debug:nn{sref}{in~non-empty;~srefin~on~\l__stex_refs_uri_str?#1}
          \stex_keys_set:nn { sref / 2 }{ #2 }
          \__stex_refs_do_sref_in:n{#1}
        }
      }
    }{
      \stex_debug:nn{sref}{No~ref~file~found~for~\l__stex_refs_uri_str}
      \str_if_empty:NTF \l_stex_key_file_str {
        \stex_debug:nn{sref}{in~empty;~autoref~on~\l__stex_refs_uri_str?#1}
        \__stex_refs_do_autoref:n{\l__stex_refs_uri_str?#1}
      }{
        \stex_debug:nn{sref}{in~non-empty;~srefin~on~\l__stex_refs_uri_str?#1}
        \stex_keys_set:nn { sref / 2 }{ #2 }
        \__stex_refs_do_sref_in:n{#1}
      }
    }
  }
}

\cs_new_protected:Nn \__stex_refs_do_sref_in:n {
  \stex_debug:nn{sref}{In: \l_stex_key_file_str^^JRepo:\l_stex_key_archive_str}
  \stex_debug:nn{sref}{URI: \l__stex_refs_uri_str?#1}
  %\msg_warning:nnn{stex}{warning/smsmissing}{<filename>}
  \begingroup\catcode13=9\relax\catcode10=9\relax
    \str_if_empty:NTF \l_stex_key_archive_str {
      \prop_if_exist:NTF \l_stex_current_repository_prop {
        \str_set:Nx \l__stex_refs_file_str {
          \stex_file_use:N \c_stex_mathhub_file /
          \prop_item:Nn \l_stex_current_repository_prop { id }
          / source / \l_stex_key_file_str .sref
        }
      }{
        \str_set:Nx \l__stex_refs_file_str {
          \stex_file_use:N \g_stex_current_file / .. / \l_stex_key_file_str . sref
        }
      }
    }{
      \str_set:Nx \l__stex_refs_file_str {
        \stex_file_use:N \c_stex_mathhub_file / \l_stex_key_archive_str
        / source / \l_stex_key_file_str . sref
      }
    }
    \stex_file_resolve:No \l__stex_refs_file \l__stex_refs_file_str
    \str_set:Nx \l__stex_refs_file_str {\stex_file_use:N \l__stex_refs_file }
    \stex_debug:nn{sref}{File: \l__stex_refs_file_str }

    \exp_args:No \IfFileExists \l__stex_refs_file_str {
      \tl_clear:N \l__stex_refs_return_tl
      \str_set:Nn \l__stex_refs_id_str {#1}
      \let\STEXInternalSrefRestoreTarget\__stex_refs_restore_target:nnnnn
      \use:c{@ @ input}{\l__stex_refs_file_str}
      \exp_args:No \tl_if_empty:nTF \l__stex_refs_return_tl {
        \exp_args:Nnno \msg_warning:nnnn{stex}{warning/smslabelmissing}\l__stex_refs_file_str{#1}
        \__stex_refs_do_autoref:n{
          \str_if_empty:NF\l__stex_refs_uri_str{\l__stex_refs_uri_str?}#1
        }
      }{
        \l__stex_refs_return_tl
      }
    }{
      \exp_args:Nnno \msg_warning:nnn{stex}{warning/smsmissing}\l__stex_refs_file_str
      \__stex_refs_do_autoref:n{
        \str_if_empty:NF\l__stex_refs_uri_str{\l__stex_refs_uri_str?}#1
      }
    }
  \endgroup
}

\cs_new_protected:Nn \__stex_refs_restore_target:nnnnn {
  \str_if_empty:NTF \l__stex_refs_uri_str {
    \exp_args:No \str_if_eq:nnT \l__stex_refs_id_str {#2}{
      \tl_set:Nn \l__stex_refs_return_tl {
        \use:c{#3autorefname}~#4\tl_if_empty:nF{#5}{~(#5)}~in~
        \tl_if_empty:NTF\l_stex_key_title_tl{
          ???
        }\l_stex_key_title_tl
      }
    }
  }{
    \stex_debug:nn{sref}{\l__stex_refs_uri_str{}~ == ~ #1 ~ ?}
    \exp_args:No \str_if_eq:nnT \l__stex_refs_uri_str {#1}{
      \stex_debug:nn{sref}{\l__stex_refs_id_str~ == ~ #2 ~ ?}
      \exp_args:No \str_if_eq:nnT \l__stex_refs_id_str {#2}{
        \stex_debug:nn{sref}{success!}
        \tl_set:Nn \l__stex_refs_return_tl {
          \use:c{#3autorefname}~#4\tl_if_empty:nF{#5}{~(#5)}~in~
          \tl_if_empty:nTF\l_stex_key_title_tl{
            ???
          }\l_stex_key_title_tl
        }
        \endinput
      }
    }
  }
}
\NewDocumentCommand \sref { O{} m O{}}{
  \stex_keys_set:nn { sref / 1 }{ #1 }
  \__stex_refs_find_uri:n { #2 }
  \__stex_refs_do_sref:nn{#2}{#3}
}
\NewDocumentCommand \extref { O{} m m}{
  \stex_keys_set:nn { sref / 1 }{ #1 }
  \__stex_refs_find_uri:n { #2 }
  \stex_keys_set:nn { sref / 2 }{ #3 }
  \str_if_empty:NT \l_stex_key_file_str {
    \msg_error:nn{stex}{error/extrefmissing}
  }
  \__stex_refs_do_sref_in:n{#2}
}
\cs_new_protected:Nn \stex_ref_new_sym_target:n {
  % TODO
}
\NewDocumentCommand \srefsym { O{} m}{
  \stex_get_symbol:n { #2 }
  \__stex_refs_sym_aux:nn{#1}{\l_stex_get_symbol_uri_str}
}

\cs_new_protected:Nn \__stex_refs_sym_aux:nn {} % TODO
\cs_new_protected:Npn \srefsymuri #1 #2 { % TODO
  #2%\__stex_refs_sym_aux:nn{linktext={#2}}{#1}
}
\tl_new:N \g__stex_smsmode_allowed_tl
\tl_new:N \g__stex_smsmode_allowed_escape_tl
\seq_new:N \g__stex_smsmode_allowedenvs_seq
\cs_new_protected:Nn \stex_sms_allow:N {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_tl {#1}
}
\cs_new_protected:Nn \stex_sms_allow_escape:N {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_escape_tl {#1}
}
\cs_new_protected:Nn \stex_sms_allow_env:n {
  \exp_args:NNx \seq_gput_right:Nn \g__stex_smsmode_allowedenvs_seq {\tl_to_str:n{#1}}
}
\stex_sms_allow:N \makeatletter
\stex_sms_allow:N \makeatother
\stex_sms_allow:N \ExplSyntaxOn
\stex_sms_allow:N \ExplSyntaxOff
\stex_sms_allow:N \rustexBREAK
\bool_new:N \g__stex_smsmode_bool
\bool_set_false:N \g__stex_smsmode_bool
\prg_new_conditional:Nnn \stex_if_smsmode: { p, T, F, TF } {
  \bool_if:NTF \g__stex_smsmode_bool \prg_return_true: \prg_return_false:
}
\tl_new:N \g__stex_smsmode_allowed_import_tl
\seq_new:N \g__stex_smsmode_allowed_import_env_seq
\cs_new_protected:Nn \stex_sms_allow_import:Nn {
  \tl_gput_right:Nn \g__stex_smsmode_allowed_import_tl {#1}
  \tl_set:cn{#1 - smsmode} {#2}
}
\cs_new_protected:Nn \stex_sms_allow_import_env:nn {
  \exp_args:NNx \seq_gput_right:Nn \g__stex_smsmode_allowed_import_env_seq {\tl_to_str{#1}}
  \tl_set:cn{#1 - env - smsmode} {#2}
}
\cs_new_protected:Nn \__stex_smsmode_in_smsmode:n { \stex_suppress_html:n {
  \vbox_set:Nn \l_tmpa_box {
    \bool_set_true:N \g__stex_smsmode_bool
    \bool_set_false:N \_stex_html_do_output_bool
    #1
  }
  \box_clear:N \l_tmpa_box
} }

\quark_new:N \q__stex_smsmode_break
\bool_set_false:N \l__stex_smsmode_in_imports_bool

\cs_new_protected:Nn \__stex_smsmode_start_smsmode:n {
  \stex_filestack_push:n{#1}
  \everyeof{\q__stex_smsmode_break\exp_not:N}
  \exp_after:wN \exp_after:wN \exp_after:wN
  \stex_smsmode_do:
  \cs:w @ @ input\cs_end: "#1" \relax
  \stex_filestack_pop:
}

\cs_new_protected:Nn \stex_file_in_smsmode:nn {
  \seq_gclear:N \l__stex_smsmode_importmodules_seq
  \seq_gclear:N \l__stex_smsmode_sigmodules_seq
  \__stex_smsmode_in_smsmode:n {
    \bool_set_true:N \l__stex_smsmode_in_imports_bool
    \tl_map_inline:Nn \g__stex_smsmode_allowed_import_tl {
      \use:c{##1 - smsmode}
    }
    \seq_map_inline:Nn \g__stex_smsmode_allowed_import_env_seq {
      \use:c{##1 - env - smsmode}
    }
    \__stex_smsmode_start_smsmode:n{#1}
  }
  \TODO imports
  \__stex_smsmode_in_smsmode:n {
    \bool_set_false:N \l__stex_smsmode_in_imports_bool
    #2
    \__stex_smsmode_start_smsmode:n{#1}
  }
}
\cs_new_protected:Nn \stex_smsmode_do: {
  \stex_if_smsmode:T {
    \__stex_smsmode_do:w
  }
}

\cs_new:Nn \__stex_smsmode_check_cs:NNn {
  \exp_after:wN\if\exp_after:wN\relax\exp_not:N#3
  \exp_after:wN#1\exp_after:wN#3\else
  \exp_after:wN#2\fi
}

\cs_new_protected:Npn \__stex_smsmode_do:w #1 {
  \exp_args:Nx \tl_if_empty:nTF { \tl_tail:n{ #1 }}{
    \__stex_smsmode_check_cs:NNn \__stex_smsmode_do_aux:N \__stex_smsmode_do:w { #1 }
  }{
    \__stex_smsmode_do:w
  }
}

\cs_new_protected:Nn \__stex_smsmode_do_aux:N {
  \cs_if_eq:NNF #1 \q__stex_smsmode_break {
    \bool_if:NTF \l__stex_smsmode_in_imports_bool {
      \__stex_smsmode_do_aux_imports:N #1
    }{
      \__stex_smsmode_do_aux_normal:N #1
    }
  }
}

\cs_new_protected:Nn \__stex_smsmode_do_aux_imports:N {
  \tl_if_in:NnTF \g__stex_smsmode_allowed_import_tl {#1} {
    #1
  }{
    \cs_if_eq:NNTF \begin #1 {
      \__stex_smsmode_check_begin:Nn \g__stex_smsmode_allowed_import_env_seq
    }{
      \cs_if_eq:NNTF \end #1 {
        \__stex_smsmode_check_end:Nn \g__stex_smsmode_allowed_import_env_seq
      }{
        \__stex_smsmode_do:w
      }
    }
  }
}

\cs_new_protected:Nn \__stex_smsmode_do_aux_normal:N {
  \tl_if_in:NnTF \g__stex_smsmode_allowed_tl {#1} {
    #1\__stex_smsmode_do:w
  }{
    \tl_if_in:NnTF \g__stex_smsmode_allowed_escape_tl {#1} {
      #1
    }{
      \cs_if_eq:NNTF \begin #1 {
        \__stex_smsmode_check_begin:Nn \g__stex_smsmode_allowedenvs_seq
      }{
        \cs_if_eq:NNTF \end #1 {
          \__stex_smsmode_check_end:Nn \g__stex_smsmode_allowedenvs_seq
        }{
          \__stex_smsmode_do:w
        }
      }
    }
  }
}

\cs_new_protected:Nn \__stex_smsmode_check_begin:Nn {
  \seq_if_in:NxTF #1 { \detokenize{#2} }{
    \begin{#2}
  }{
    \__stex_smsmode_do:w
  }
}
\cs_new_protected:Nn \__stex_smsmode_check_end:Nn {
  \seq_if_in:NxTF #1 { \detokenize{#2} }{
    \end{#2}\__stex_smsmode_do:w
  }{
    \str_if_eq:nnTF{#2}{document} \endinput \__stex_smsmode_do:w
  }
}
\str_new:N \l_stex_current_module_str
\cs_new:Nn \stex_current_module_prop: {
  \exp_after:wN \exp_not:N \cs:w c_stex_module_\l_stex_current_module_str _prop \cs_end:
}
\seq_new:N \l_stex_all_modules_seq
\tl_set:Nn \g_stex_every_module_tl {
  \stex_metagroup_new:o \l_stex_current_module_str
}
\cs_new_protected:Nn \stex_every_module:n {
  \tl_gput_right:Nn \g_stex_every_module_tl { #1 }
}
\cs_new_protected:Nn \__stex_module_setup_get_uri_str:n {
  \str_clear:N \l__stex_module_setup_ns_str
  \stex_map_uri:Nnnnn \l_stex_current_ns_uri {
    \str_set:Nx \l__stex_module_setup_ns_str{##1\c_colon_str/}
  }{
    \seq_set_split:Nnn \l__stex_module_setup_seq / {##1}
    \seq_pop_right:NN \l__stex_module_setup_seq \l__stex_module_setup_seg
    \exp_args:No \str_if_eq:nnF \l__stex_module_setup_seg {#1} {
      \seq_put_right:No \l__stex_module_setup_seq \l__stex_module_setup_seg
    }
    \tl_put_right:Nx \l__stex_module_setup_ns_str {\seq_use:Nn \l__stex_module_setup_seq /}
  }{}{}
}

\cs_new_protected:Nn \__stex_module_setup_setup_top_nosig:n {
  \stex_if_module_exists:nTF{\l__stex_module_setup_ns_str?#1}{
    \stex_debug:nn{modules}{(already exists)}
  }{
    \prop_clear:N \l__stex_module_setup_prop
    \prop_put:Nnn \l__stex_module_setup_prop {name} { #1 }
    \prop_put:Nno \l__stex_module_setup_prop {ns} \l__stex_module_setup_ns_str

    \prop_set_eq:cN {c_stex_module_ \l__stex_module_setup_ns_str ? #1 _prop}\l__stex_module_setup_prop
  }
  \str_set:Nx \l_stex_current_module_str {\l__stex_module_setup_ns_str?#1}
  \seq_put_right:No \l_stex_all_modules_seq \l_stex_current_module_str
}

\cs_new_protected:Nn \__stex_module_setup_setup_top_sig:n {
  \stex_if_module_exists:nTF{\l__stex_module_setup_ns_str?#1}{
    \stex_debug:nn{modules}{(already exists)}
  }{
    \stex_debug:nn{modules}{(needs loading)}
    \TODO
  }
  \stex_if_smsmode:F { % WHY?
    \stex_activate_module:n {
      \l_stex_module_ns_str ? \l_stex_module_name_str
    }
  }
  \str_set:Nx\l_stex_current_module_str{\l__stex_module_setup_ns_str?#1}
  \seq_put_right:No \l_stex_all_modules_seq \l_stex_current_module_str
}

\cs_new_protected:Nn \__stex_module_setup_setup_top:n {
  \__stex_module_setup_get_uri_str:n{#1}
  \stex_debug:nn{module}{Module~URI:~\l__stex_module_setup_ns_str?#1}
  \str_if_empty:NTF \l_stex_key_sig_str
  \__stex_module_setup_setup_top_nosig:n \__stex_module_setup_setup_top_sig:n {#1}
  \g_stex_every_module_tl
  \__stex_module_setup_load_meta:
  \cs_set_eq:NN \stex_module_setup:n \__stex_module_setup_setup_nested:n
}

\cs_new_protected:Nn \__stex_module_setup_setup_nested:n {
  \str_set:Nx \l__stex_module_setup_ns_str {\prop_item:cn{
    c_stex_module_ \l_stex_current_module_str _prop
  }{ns}}
  \exp_args:Nx \__stex_module_setup_setup_top_nosig:n {\prop_item:cn{
    c_stex_module_ \l_stex_current_module_str _prop
  }{name} / #1}
  \stex_debug:nn{module}{Nested~Module~URI:~\l_stex_current_module_str}
  \seq_put_right:No \l_stex_all_modules_seq \l_stex_current_module_str
}

\bool_new:N \l_stex_in_meta_bool
\bool_set_false:N \l_stex_in_meta_bool

\cs_new_protected:Nn \__stex_module_setup_load_meta: {
  \tl_if_empty:NF \l_stex_metatheory_uri {
    \stex_pseudogroup_with:nn{\l_stex_in_meta_bool}{
      \TODO
    }
  }
}

\cs_set_eq:NN \stex_module_setup:n \__stex_module_setup_setup_top:n
\cs_new:Nn \stex_close_module: {
  \stex_if_smsmode:T {
    \stex_persist:x{
      \prop_set_from_keyval:Nn \stex_current_module_prop: {
        \exp_after:wN \prop_to_keyval:N \cs:w c_stex_module_\l_stex_current_module_str _prop\cs_end:
      }
      % TODO more
      \tl_set:cn{c_stex_module_\l_stex_current_module_str _code}{
        \exp_after:wN \exp_after:wN \exp_after:wN \exp_not:n
        \exp_after:wN \exp_after:wN \exp_after:wN \exp_not:n
        { \cs:w c_stex_module_\l_stex_current_module_str _code \cs_end: }
      }
    }
  }
}
\tl_new:N \l_stex_metatheory_uri
\cs_new_protected:Nn \__stex_modules_set_metatheory:nn {
  %\stex_import_module_uri:nn { #1 } { #2 }
  %\stex_import_require_module:nnnn
  %{ \l_stex_import_ns_str } { \l_stex_import_archive_str }
  %{ \l_stex_import_path_str } { \l_stex_import_name_str }
  %\str_set:Nx \l_stex_metatheory_str { \l_stex_import_ns_str ? \l_stex_import_name_str }
  \TODO
}

\NewDocumentCommand \setmetatheory {O{} m}{
  \__stex_modules_set_metatheory:nn { #1 }{ #2 }
  \stex_smsmode_do:
}
\stex_keys_define:nnnn{smodule}{
  \str_clear:N \l_stex_key_deprecate_str
  \str_clear:N \l_stex_key_sig_str
}{
  %meta          .str_set_x:N  = \l_stex_key_metatheory_str ,
  meta          .code:n       = {
    \str_if_empty:nTF {#1}{
      \tl_clear:N \l_stex_metatheory_uri
    }{
      \stex_uri_resolve:Nx \l_stex_metatheory_uri { #1 }
    }
  },
  ns            .code:n       = {
    \stex_uri_resolve:Nx \l_stex_current_ns_uri { #1 }
  } ,
  lang          .code:n       = {
    \stex_set_language:n { #1 }
  } ,
  deprecate     .str_set_x:N  = \l_stex_key_deprecate_str ,
  sig           .str_set_x:N  = \l_stex_key_sig_str ,
  creators      .code:n       = {} , % todo ?
  contributors  .code:n       = {} , % todo ?
  srccite       .code:n       = {}   % todo ?
}{id, title, style}
\stex_new_stylable_env:nnnnnn {module} {O{} m}{
  \stex_keys_set:nn { smodule }{ #1 }
  \exp_args:Nx \stex_module_setup:n { \tl_to_str:n{ #2 } }

  \stex_if_do_html:T {
    \begin{stex_annotate_env} {stex:theory} {
      \l_stex_current_module_str
    }
    \stex_annotate_invisible:nnn{stex:header}{}{
      \stex_annotate:nnn{stex:language}{ \l_stex_current_language_str}{}
      \stex_annotate:nnn{stex:signature}{ \l_stex_key_sig_str }{}
      \tl_if_empty:NF \l_stex_metatheory_uri {
        \stex_annotate:nnn{stex:metatheory}{ \stex_uri_use:N \l_stex_metatheory_uri }
      }
      %\str_if_empty:NF \thisstyle {
      %  \stex_annotate:nnn{stex:type}{\thisstyle}{}
      %}
    }
  }
  \stex_if_smsmode:F \stex_style_apply:

  \stex_smsmode_do:
}{
  \stex_close_module:
  \stex_if_smsmode:F \stex_style_apply:
  \stex_if_do_html:T{ \end{stex_annotate_env} }
}{}{}

\stex_sms_allow_env:n{smodule}
\prg_new_conditional:Nnn \stex_if_in_module: {p, T, F, TF} {
  \str_if_empty:NTF \l_stex_current_module_str
    \prg_return_false: \prg_return_true:
}
\prg_new_conditional:Nnn \stex_if_module_exists:n {p, T, F, TF} {
  \prop_if_exist:cTF { c_stex_module_#1_prop }
    \prg_return_true: \prg_return_false:
}
\cs_new_protected:Nn \stex_do_up_to_module:n {
  \exp_args:No \stex_metagroup_do_in:nn \l_stex_current_module_str {#1}
}
\cs_generate_variant:Nn \stex_do_up_to_module:n {x}
\cs_new_protected:Nn \stex_add_to_current_module:n {
  \tl_gput_right:cn {c_stex_module_\l_stex_current_module_str _code} { #1 }
}
\cs_generate_variant:Nn \stex_add_to_current_module:n {x}
\cs_new_protected:Nn \stex_execute_in_module:n { \stex_if_in_module:TF {
  \stex_add_to_current_module:n { #1 }
  \stex_do_up_to_module:n { #1 }
}{ #1 }}
\cs_generate_variant:Nn \stex_execute_in_module:n {x}
\NewDocumentCommand \STEXexport {} {
  \ExplSyntaxOn
  \__stex_modules_export:n
}
\cs_new_protected:Nn \__stex_modules_export:n {
  \ignorespacesandpars#1\ExplSyntaxOff
  \stex_add_to_current_module:n { \ignorespacesandpars#1}
  \stex_smsmode_do:
}
\stex_deactivate_macro:Nn \STEXexport {module~environments}
\stex_sms_allow_escape:N \STEXexport
\tl_put_right:Nn \g_stex_every_module_tl {\stex_reactivate_macro:N \STEXexport}
\cs_new_protected:Nn \stex_get_current_namespace: {
  \stex_uri_from_current_file_nolang:Nn \l_stex_current_ns_uri {source-base}
  \stex_debug:nn{modules}{Namespace~URI:~\stex_uri_use:N \l_stex_current_ns_uri}
}
\NewDocumentEnvironment { mmtinterface } { O{} m m } {
  \TODO
}{}
\cs_new_protected:Nn \stex_activate_module:n {
  \exp_args:NNx \seq_if_in:NnF \l_stex_all_modules_seq { #1 } {
    \stex_debug:nn{modules}{Activating~module~#1}
    \seq_put_right:Nx \l_stex_all_modules_seq { #1 }
    \TODO % \use:c{ c_stex_module_#1_code }
    % morphisms
  }
}
\cs_new_protected:Nn \stex_import_module_uri:nn {
  \exp_args:NNnx \seq_set_split:Nnn \__stex_importmodule_seq ? { \tl_to_str:n{ #2 } }
  \seq_pop_right:NN \__stex_importmodule_seq \l_stex_import_name_str
  \str_set:Nx \l_stex_import_path_str { \seq_use:Nn \__stex_importmodule_seq ? }
  \tl_if_empty:nTF { #1 } {
    \prop_if_exist:NTF \l_stex_current_repository_prop {
      \str_set:Nx \l_stex_import_archive_str {
        \prop_item:Nn \l_stex_current_repository_prop { id }
      }
    }{
      \str_clear:N \l_stex_import_archive_str
      \str_if_empty:NTF \l_stex_import_path_str {
        \str_set:Nx \l_stex_import_path_str {
          \stex_file_use:N \g_stex_current_file / ..
        }
      }{
        \stex_file_resolve:Nx \l__stex_importmodule_seq { \stex_file_use:N \g_stex_current_file / .. / \l_stex_import_path_str}
        \str_set:Nx \l_stex_import_path_str {
          \stex_file_use:N \l__stex_importmodule_seq
        }
      }
    }
  } {
    \str_set:Nx \l_stex_import_archive_str { #1 }
    \stex_require_respository:o \l_stex_import_archive_str
  }
}
\cs_new_protected:Npn \stex_import_require_module:nnn #1 {
  \tl_if_empty:nTF { #1 } {
    \str_clear:N \l__stex_importmodule_archive_str
    \str_set:Nn \l__stex_importmodule_uri {file:}
    \__stex_importmodule_get_module:nnn {}
  }{
    \str_set:Nx \l__stex_importmodule_archive_str {#1}
    \str_set:Nx \l__stex_importmodule_uri { \prop_item:cn{ c_stex_mathhub_ #1 _manifest_prop}{ ns } }
    \str_set:Nx \l__stex_importmodule_str { \stex_file_use:N \c_stex_mathhub_file / #1 / source }
    \exp_args:No \__stex_importmodule_get_module:nnn \l__stex_importmodule_str
  }
}

\cs_new_protected:Nn \__stex_importmodule_get_module:nnn {
  \tl_if_empty:nF {#2}{
    \str_set:Nx \l__stex_importmodule_uri {\l__stex_importmodule_uri / #2}
  }
  \stex_if_module_exists:nF {\l__stex_importmodule_uri?#3} {
    \__stex_importmodule_get_from_file:nnn{#1}{#2}{#3}
  }
  %\TODO
}

\cs_new_protected:Nn \__stex_importmodule_get_from_file:nnn {
  \str_clear:N \l_stex_import_ns_str
  \stex_file_resolve:Nx \l__stex_importmodule_seq { \tl_if_empty:nF{ #1 }{ #1 / } #2 }
  \str_set:Nx \l__stex_importmodule_str {\stex_file_use:N \l__stex_importmodule_seq}
  \stex_debug:nn{imports}{Looking~for~\l__stex_importmodule_uri?#3...}
  \__stex_importmodule_check_file:nn{ .tex }{
    \__stex_importmodule_check_file:nn{. \l_stex_current_language_str .tex}{
      \__stex_importmodule_check_file:nn{.en.tex}{
        \__stex_importmodule_check_file:nn{/#3.tex}{
          \__stex_importmodule_check_file:nn{/#3.\l_stex_current_language_str .tex}{
            \__stex_importmodule_check_file:nn{/#3.en.tex}{
              \msg_error:nnx{stex}{error/unknownmodule}{\l__stex_importmodule_uri?#3}
            }
          }
        }
      }
    }
  }
  \__stex_importmodule_load_file:n{#3}
}

\cs_new_protected:Nn \__stex_importmodule_load_file:n {
  \stex_file_in_smsmode:nn{\l__stex_importmodule_str}{
    \seq_clear:N \l_stex_all_modules_seq
    \str_clear:N \l_stex_current_module_str
    \str_if_empty:NF \l__stex_importmodule_archive_str {
      \stex_set_current_repository:n \l__stex_importmodule_srchive_str
    }
    \stex_debug:nn{modules}{Loading~\l__stex_importmodule_str}
  }
  \stex_if_module_exists:nF {\l__stex_importmodule_uri?#1} {
    \msg_error:nnx{stex}{error/unknownmodule}{\l__stex_importmodule_uri?#1}
  }
}

\cs_new_protected:Npn \__stex_importmodule_check_file:nn #1 {
  \stex_debug:nn{imports}{Checking~\l__stex_importmodule_str #1}
  \IfFileExists{ \l__stex_importmodule_str #1 }{
    \stex_debug:nn{imports}{Success}
    \str_set:Nx \l__stex_importmodule_str { \l__stex_importmodule_str #1 }
  }
}


\stex_read_persist:
\cs_undefine:N \stex_read_persist:

\endinput
%%
%% End of file `stex.sty'.
